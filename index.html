<!DOCTYPE html>
<html>
<head>
    <title>Kiosk Web Content</title>
</head>
<body>
<h1>Инициализация Киоска</h1>
<h1 id="device-id"></h1>
<div id="usb-device-list">
    <p>Загрузка статуса USB...</p>
</div>

<!--<h1>Список USB-устройств:</h1>-->
<!--<div id="kiosk-data-output" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">-->
<!--    Загрузка списка USB-устройств...-->
<!--</div>-->
<script>
    const deviceListContainer = document.getElementById('usb-device-list');

    // Функция для преобразования строки (если Kotlin возвращает toString())
    // В реальном приложении здесь должен быть JSON.parse(kotlinResult)
    function parseKotlinList(str) {
        return JSON.parse(str);
        // Заглушка, если нет JSON-библиотеки в Kotlin
        // Предполагаем, что вам нужно будет настроить парсинг под ваш строковый формат.
        // Идеально: использовать JSON.parse().
        return [{vid: 1008, pid: 15127, deviceName: "HP Printer", hasPermission: false}];
    }

    // 1. ПОЛУЧЕНИЕ СПИСКА УСТРОЙСТВ
    function fetchUsbDevices() {
        const command = {
            action: "USB_IO_COMMAND",
            parameters: { action_type: "GET_DEVICES" }
        };

        // !!! НОВЫЙ ВЫЗОВ: Передаем имя функции-обработчика !!!
        AndroidBridge.executeCommandAsync(JSON.stringify(command), "handleUsbResult");
    }

    // JS: Функция, которая получит ответ от Kotlin
    function handleUsbResult(resultString) {
        if (!resultString || resultString.startsWith("USB_ERROR:")) {
            deviceListContainer.innerHTML = `<p style='color: red;'>Ошибка Bridge/Kotlin: ${resultString || 'Пустой ответ'}</p>`;
            return;
        }

        try {
            const devices = JSON.parse(resultString);
            renderDeviceList(devices);
        } catch (e) {
            deviceListContainer.innerHTML = `<p style='color: red;'>Ошибка парсинга JSON: ${e.message}</p>`;
        }
    }

    // 2. ОТПРАВКА ЗАПРОСА РАЗРЕШЕНИЯ (АСИНХРОННАЯ ВЕРСИЯ)
    function requestPermission(vid, pid) {
        const command = {
            action: "USB_IO_COMMAND",
            parameters: { action_type: "REQUEST_PERMISSION", vid: vid, pid: pid }
        };

        const button = document.getElementById(`btn-${vid}-${pid}`);
        button.disabled = true;
        button.innerText = 'Ожидание подтверждения...';

        try {
            // !!! ИСПРАВЛЕНИЕ !!!: Используем handleOperationStatus для получения статуса
            const launchStatus = AndroidBridge.executeCommandAsync(
                JSON.stringify(command),
                "handleOperationStatus" // <--- НОВАЯ ФУНКЦИЯ CALLBACK
            );

            console.log("Запрос разрешения запущен, статус:", launchStatus);

        } catch (e) {
            alert("Критическая ошибка запуска Bridge: " + e.message);
            button.disabled = false;
            button.innerText = 'Запросить разрешение';
        }
    }

    // 3. ОТОБРАЖЕНИЕ СПИСКА В HTML
    function renderDeviceList(devices) {
        let html = '<h3>Статус USB-устройств:</h3><ul>';

        devices.forEach(device => {
            const status = device.hasPermission ? '✅ Разрешено' : '❌ Нет разрешения';
            const buttonText = device.hasPermission ? 'Подтверждено' : 'Запросить разрешение';
            const buttonId = `btn-${device.vid}-${device.pid}`;

            html += `
                <li>
                    <strong>${device.deviceName}</strong> (VID:${device.vid}, PID:${device.pid})
                    — Статус: ${status}
                    <button
                        id="${buttonId}"
                        onclick="requestPermission(${device.vid}, ${device.pid})"
                        ${device.hasPermission ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                </li>
            `;
        });

        html += '</ul>';
        deviceListContainer.innerHTML = html;
    }

    // JS: Функция, которая получит результат выполнения операций (REQUEST_PERMISSION, Печать)
    function handleOperationStatus(resultString) {
        if (resultString && resultString.startsWith("USB Error:")) {
            alert("Ошибка операции: " + resultString);
        } else {
            alert("Операция завершена: " + resultString);
        }

        // После получения статуса (Успех/Ошибка), всегда обновляем список,
        // чтобы увидеть новый статус разрешения.
        fetchUsbDevices();
    }

    function loadKioskData() {
        const outputElement = document.getElementById('kiosk-data-output');
        outputElement.innerHTML = 'Загрузка...';

        // Проверяем, доступен ли нативный мост
        if (typeof AndroidBridge !== 'undefined' && AndroidBridge.getKioskData) {
            try {
                // 1. Вызов нативного метода и получение JSON-строки
                const jsonString = AndroidBridge.getKioskData();

                // 2. Парсинг JSON
                const kioskData = JSON.parse(jsonString);

                const deviceIdElement = document.getElementById('device-id');
                deviceIdElement.innerText = kioskData.device_id;

                // // 3. Отображение данных
                // let htmlOutput = '<h2>Kiosk Data (Получено с Android):</h2>';
                // htmlOutput += `<p><b>Device ID:</b> ${kioskData.device_id}</p>`;
                // // htmlOutput += `<p><b>FCM Token:</b> ${kioskData.fcm_token}</p>`;
                // // htmlOutput += `<p><b>Last Check:</b> ${new Date(kioskData.last_check).toLocaleString()}</p>`;
                //
                // htmlOutput += '<h3>USB Devices:</h3>';
                // if (kioskData.usb_devices && kioskData.usb_devices.length > 0) {
                //     htmlOutput += '<ul>';
                //     kioskData.usb_devices.forEach(device => {
                //         htmlOutput += `<li>Name: ${device.name}, VID: ${device.vendor_id}, PID: ${device.product_id}</li>`;
                //     });
                //     htmlOutput += '</ul>';
                // } else {
                //     htmlOutput += '<p>USB-устройства не найдены.</p>';
                // }
                //
                // outputElement.innerHTML = htmlOutput;

            } catch (e) {
                outputElement.innerHTML =
                    `ОШИБКА: Не удалось вызвать метод или распарсить JSON. Сообщение: ${e.message}`;
            }
        } else {
            outputElement.innerHTML =
                'ОШИБКА: Объект AndroidBridge или метод getKioskData не найдены.';
        }
    }


    // Запуск при загрузке страницы
    fetchUsbDevices();
    loadKioskData();
</script>
</body>
</html>
