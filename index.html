<!DOCTYPE html>
<html>
<head>
    <title>Kiosk Web Content</title>
</head>
<body>
<h1>Инициализация Киоска</h1>
<div id="usb-device-list">
    <p>Загрузка статуса USB...</p>
</div>
<script>
    const deviceListContainer = document.getElementById('usb-device-list');

    // Функция для преобразования строки (если Kotlin возвращает toString())
    // В реальном приложении здесь должен быть JSON.parse(kotlinResult)
    function parseKotlinList(str) {
        return JSON.parse(str);
        // Заглушка, если нет JSON-библиотеки в Kotlin
        // Предполагаем, что вам нужно будет настроить парсинг под ваш строковый формат.
        // Идеально: использовать JSON.parse().
        return [{vid: 1008, pid: 15127, deviceName: "HP Printer", hasPermission: false}];
    }

    // 1. ПОЛУЧЕНИЕ СПИСКА УСТРОЙСТВ
    function fetchUsbDevices() {
        const command = {
            action: "USB_IO_COMMAND",
            parameters: { action_type: "GET_DEVICES" }
        };

        try {
            const resultString = AndroidBridge.executeCommand(JSON.stringify(command));

            if (!resultString) {
                // Если Kotlin вернул null или пустую строку
                deviceListContainer.innerHTML = "<p style='color: red;'>Ошибка: Kotlin не вернул данные (null/пусто).</p>";
                return;
            }

            // Если Kotlin вернул JSON-строку
            const devices = JSON.parse(resultString);

            // Если devices - это массив, вызываем отрисовку
            if (Array.isArray(devices)) {
                renderDeviceList(devices);
            } else if (devices && devices.error) {
                // Обработка ошибки, если мы вернули JSON-ошибку из Kotlin
                deviceListContainer.innerHTML = `<p style='color: red;'>Ошибка в Kotlin: ${devices.error}</p>`;
            } else {
                // Отобразить сырую строку для отладки, если не JSON
                deviceListContainer.innerHTML = resultString;
            }

        } catch (e) {
            deviceListContainer.innerHTML = `<p style='color: red;'>Ошибка Bridge/JSON-парсинга: ${e.message}</p>`;
        }
    }

    // 2. ОТПРАВКА ЗАПРОСА РАЗРЕШЕНИЯ
    function requestPermission(vid, pid) {
        const command = {
            action: "USB_IO_COMMAND",
            parameters: { action_type: "REQUEST_PERMISSION", vid: vid, pid: pid }
        };

        const button = document.getElementById(`btn-${vid}-${pid}`);
        button.disabled = true;
        button.innerText = 'Ожидание...';

        try {
            const result = AndroidBridge.executeCommand(JSON.stringify(command));
            alert(result);

            // После подтверждения/отказа, обновляем список, чтобы увидеть новый статус
            fetchUsbDevices();

        } catch (e) {
            alert("Критическая ошибка: " + e.message);
            fetchUsbDevices(); // Перезагружаем на случай ошибки
        }
    }

    // 3. ОТОБРАЖЕНИЕ СПИСКА В HTML
    function renderDeviceList(devices) {
        let html = '<h3>Статус USB-устройств:</h3><ul>';

        devices.forEach(device => {
            const status = device.hasPermission ? '✅ Разрешено' : '❌ Нет разрешения';
            const buttonText = device.hasPermission ? 'Подтверждено' : 'Запросить разрешение';
            const buttonId = `btn-${device.vid}-${device.pid}`;

            html += `
                <li>
                    <strong>${device.deviceName}</strong> (VID:${device.vid}, PID:${device.pid})
                    — Статус: ${status}
                    <button
                        id="${buttonId}"
                        onclick="requestPermission(${device.vid}, ${device.pid})"
                        ${device.hasPermission ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                </li>
            `;
        });

        html += '</ul>';
        deviceListContainer.innerHTML = html;
    }

    // Запуск при загрузке страницы
    fetchUsbDevices();
</script>
</body>
</html>
